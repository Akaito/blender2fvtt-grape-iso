{
  "_id": "tZ6P3VnDG01IXp9U",
  "name": "blender2grape-iso",
  "type": "script",
  "sort": 100001,
  "flags": {
    "exportSource": {
      "world": "5e-srd",
      "system": "dnd5e",
      "coreVersion": "0.7.9",
      "systemVersion": "1.2.0"
    }
  },
  "scope": "global",
  "command": "const gridSize = canvas.scene.data.grid;\nconst foundrySceneOrigin = [\n  Math.floor((canvas.scene.data.width\n    + canvas.scene.data.padding*2*canvas.scene.data.width) / 2),\n  Math.floor((canvas.scene.data.height +\n    canvas.scene.data.padding*2*canvas.scene.data.height) / 2),\n];\nconst isoWallsFolder = `worlds/${game.world.name}/assets/${canvas.scene.name}/iso-walls`;\nmain();\nui.notifications.info(`Copy rendered walls to ${isoWallsFolder}/`);\n\n\nasync function main() {\n  let jsn = get_blender_jsn();\n  // Walls\n  let newWalls = [];\n  jsn['blenderWalls']?.map(wall => {newWalls.push.apply(newWalls, blenderWall2FoundryWalls(wall));});\n  let createdWalls = await canvas.scene.createEmbeddedEntity('Wall', newWalls);\n  console.log('createdWalls: ', createdWalls);\n\n  // Tiles\n  let newTiles = [];\n  jsn['blenderWalls']?.forEach(wall => {newTiles.push(blenderWall2Tile(wall));});\n  let createdTiles = await canvas.scene.createEmbeddedEntity('Tile', newTiles);\n  console.log('createdTiles:', createdTiles);\n\n  await hookWalls(createdWalls, createdTiles);\n\n  //let w = canvas.walls.filter(w => w.flags?.blender2grapeiso?.blenderObjectName === 'wall.001');\n  //console.log(w);\n\n\n  canvas.walls.activate();  // switch to walls layer\n}\n\n\n\n\n// Flip x and y from the Blender export.\n// This is kind of a hack.\n// Blender's camera is assumed to be looking down neg-x, pos-y.\n// Foundry in Grape's isometric is looking down pos-x, neg-y.\nfunction blenderWall2FoundryWalls(blenderWallJson) {\n  let result = [];\n  blenderWallJson?.foundryWalls?.forEach(wallJson => {\n    let sense = CONST.WALL_SENSE_TYPES.NORMAL;\n    if (wallJson['isFrontFacing'] !== true)\n      sense = CONST.WALL_SENSE_TYPES.NONE;\n    result.push({\n      c: [\n        foundrySceneOrigin[0] + wallJson.a.world[1] * gridSize,\n        foundrySceneOrigin[1] + wallJson.a.world[0] * gridSize,\n        foundrySceneOrigin[0] + wallJson.b.world[1] * gridSize,\n        foundrySceneOrigin[1] + wallJson.b.world[0] * gridSize\n      ],\n      sense: sense,\n      flags: {\n        blender2grapeiso: {\n          blenderObjectName: blenderWallJson.blenderObjectName,\n          isFrontFacing: wallJson['isFrontFacing'],\n        }\n      },\n    });\n  });\n  return result;\n}\n\n\nfunction blenderWall2Tile(blenderWallJson) {\n  //console.log(blenderWallJson);\n  return {\n    //img: 'icons/svg/wall-direction.svg',\n    img: `${isoWallsFolder}/${blenderWallJson.blenderObjectName}.png`,\n    width: 400,\n    height: 400,\n    x: foundrySceneOrigin[0] + blenderWallJson.foundryWalls[0].a.world[1] * gridSize,\n    y: foundrySceneOrigin[1] + blenderWallJson.foundryWalls[0].a.world[0] * gridSize,\n    z: 300,\n    hidden: false,\n    locked: true,\n    flags: {\n      blender2grapeiso: {\n        blenderObjectName: blenderWallJson['blenderObjectName'],\n      },\n    },\n  };\n}\n\n\nasync function hookWalls(wallDatas, tileDatas) {\n  for (let tileData of tileDatas) {\n    console.log('tileData:', tileData);\n    console.log('wallDatas:', wallDatas);\n    let frontWallDatas = wallDatas\n      .filter(w => w.flags.blender2grapeiso.blenderObjectName === tileData.flags.blender2grapeiso.blenderObjectName)\n      .filter(w => w.flags.blender2grapeiso.isFrontFacing === true);\n    console.log('frontWallDatas:', frontWallDatas);\n    await canvas.tiles.get(tileData._id)\n      .setFlag(\n        'grape_juice-isometrics',\n        'attach_wall_id',\n        frontWallDatas.map(w => w._id).join(',')\n      );\n    await canvas.tiles.get(tileData._id)\n      .setFlag('grape_juice-isometrics', 'hook_door_id', '');\n    await canvas.tiles.get(tileData._id)\n      .setFlag('grape_juice-isometrics', 'tile_alpha', '0');\n  }\n}\n\n\nfunction get_blender_jsn() {\n  return {\n  \"blenderWalls\": [\n    {\n      \"blenderObjectName\": \"wall.003\",\n      \"foundryWalls\": [\n        {\n          \"a\": {\n            \"renderCamera\": [\n              1.199113,\n              -1.153845\n            ],\n            \"world\": [\n              6.0,\n              1.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              1.199113,\n              -1.153845\n            ],\n            \"world\": [\n              6.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": false\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              2.264992,\n              -1.769224\n            ],\n            \"world\": [\n              10.0,\n              1.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              2.264992,\n              -1.769224\n            ],\n            \"world\": [\n              6.0,\n              1.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": false\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              1.998522,\n              -1.923069\n            ],\n            \"world\": [\n              10.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              1.998522,\n              -1.923069\n            ],\n            \"world\": [\n              10.0,\n              1.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": true\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              0.932644,\n              -1.30769\n            ],\n            \"world\": [\n              6.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              0.932644,\n              -1.30769\n            ],\n            \"world\": [\n              10.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": true\n        }\n      ]\n    },\n    {\n      \"blenderObjectName\": \"wall.001\",\n      \"foundryWalls\": [\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -0.399704,\n              -0.230776\n            ],\n            \"world\": [\n              0.0,\n              1.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -0.399704,\n              -0.230776\n            ],\n            \"world\": [\n              0.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": false\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              0.666174,\n              -0.846155\n            ],\n            \"world\": [\n              4.0,\n              1.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              0.666174,\n              -0.846155\n            ],\n            \"world\": [\n              0.0,\n              1.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": false\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              0.399705,\n              -1.0\n            ],\n            \"world\": [\n              4.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              0.399705,\n              -1.0\n            ],\n            \"world\": [\n              4.0,\n              1.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": true\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -0.666174,\n              -0.384621\n            ],\n            \"world\": [\n              0.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -0.666174,\n              -0.384621\n            ],\n            \"world\": [\n              4.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": true\n        }\n      ]\n    },\n    {\n      \"blenderObjectName\": \"wall.002\",\n      \"foundryWalls\": [\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -1.998522,\n              -0.846156\n            ],\n            \"world\": [\n              -1.0,\n              -4.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -1.998522,\n              -0.846156\n            ],\n            \"world\": [\n              0.0,\n              -4.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": true\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -0.932643,\n              -0.230776\n            ],\n            \"world\": [\n              -1.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -0.932643,\n              -0.230776\n            ],\n            \"world\": [\n              -1.0,\n              -4.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": false\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -0.666174,\n              -0.384621\n            ],\n            \"world\": [\n              0.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -0.666174,\n              -0.384621\n            ],\n            \"world\": [\n              -1.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": false\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -1.732052,\n              -1.0\n            ],\n            \"world\": [\n              0.0,\n              -4.0,\n              0.0\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -1.732052,\n              -1.0\n            ],\n            \"world\": [\n              0.0,\n              0.0,\n              0.0\n            ]\n          },\n          \"isFrontFacing\": true\n        }\n      ]\n    },\n    {\n      \"blenderObjectName\": \"wall.weird\",\n      \"foundryWalls\": [\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -1.084526,\n              -1.576934\n            ],\n            \"world\": [\n              2.903578,\n              -4.473557,\n              -0.186482\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -1.084526,\n              -1.576934\n            ],\n            \"world\": [\n              2.010673,\n              -6.263172,\n              -0.186482\n            ]\n          },\n          \"isFrontFacing\": false\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -1.268784,\n              -1.831637\n            ],\n            \"world\": [\n              3.385627,\n              -5.647088,\n              -0.186482\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -1.268784,\n              -1.831637\n            ],\n            \"world\": [\n              2.903578,\n              -4.473557,\n              -0.186482\n            ]\n          },\n          \"isFrontFacing\": true\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -1.799335,\n              -1.714889\n            ],\n            \"world\": [\n              2.010673,\n              -6.263172,\n              -0.186482\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -1.799335,\n              -1.714889\n            ],\n            \"world\": [\n              3.035263,\n              -6.450493,\n              -0.186482\n            ]\n          },\n          \"isFrontFacing\": true\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              -1.576229,\n              -1.901335\n            ],\n            \"world\": [\n              3.035263,\n              -6.450493,\n              -0.186482\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              -1.576229,\n              -1.901335\n            ],\n            \"world\": [\n              3.385627,\n              -5.647088,\n              -0.186482\n            ]\n          },\n          \"isFrontFacing\": true\n        }\n      ]\n    },\n    {\n      \"blenderObjectName\": \"wall.concave\",\n      \"foundryWalls\": [\n        {\n          \"a\": {\n            \"renderCamera\": [\n              0.549949,\n              -1.841706\n            ],\n            \"world\": [\n              6.830998,\n              -2.267165,\n              -0.186482\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              0.549949,\n              -1.841706\n            ],\n            \"world\": [\n              6.830998,\n              -4.267165,\n              -0.186482\n            ]\n          },\n          \"isFrontFacing\": false\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              0.321208,\n              -2.178903\n            ],\n            \"world\": [\n              7.497692,\n              -3.792273,\n              -0.186482\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              0.321208,\n              -2.178903\n            ],\n            \"world\": [\n              6.830998,\n              -2.267165,\n              -0.186482\n            ]\n          },\n          \"isFrontFacing\": true\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              0.01701,\n              -2.149395\n            ],\n            \"world\": [\n              6.830998,\n              -4.267165,\n              -0.186482\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              0.01701,\n              -2.149395\n            ],\n            \"world\": [\n              8.830998,\n              -4.267165,\n              -0.186482\n            ]\n          },\n          \"isFrontFacing\": true\n        },\n        {\n          \"a\": {\n            \"renderCamera\": [\n              0.549949,\n              -2.457085\n            ],\n            \"world\": [\n              8.830998,\n              -4.267165,\n              -0.186482\n            ]\n          },\n          \"b\": {\n            \"renderCamera\": [\n              0.549949,\n              -2.457085\n            ],\n            \"world\": [\n              7.497692,\n              -3.792273,\n              -0.186482\n            ]\n          },\n          \"isFrontFacing\": false\n        }\n      ]\n    }\n  ]\n}\n}",
  "author": "2pwDDMtPZQq5dX12",
  "img": "icons/svg/castle.svg",
  "actorIds": []
}